<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ äººå¯µé…å° v3.9</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>

    <style>
        body { padding: 20px; text-align: center; max-width: 800px; margin: 0 auto; background-color: #fdfbf7; font-family: 'Segoe UI', sans-serif; }
        .preview-box { width: 180px; height: 180px; border: 3px solid #eee; margin: 30px auto; position: relative; cursor: pointer; background: #fff; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .img-container { width: 100%; height: 100%; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        img { width: 100%; height: 100%; object-fit: cover; }
        
        .bubble {
            background: #fff; color: #333; padding: 10px 15px; border-radius: 15px;
            font-size: 0.8rem; font-weight: bold; line-height: 1.4;
            position: absolute; top: -50px; right: -70px; width: 150px; z-index: 100; display: none; 
            box-shadow: 3px 3px 10px rgba(0,0,0,0.15); border: 2px solid #333; pointer-events: none;
        }
        .bubble::after { content: ''; position: absolute; bottom: -10px; left: 20px; border-width: 12px 10px 0; border-style: solid; border-color: #333 transparent; display: block; width: 0; }
        .bubble::before { content: ''; position: absolute; bottom: -6px; left: 23px; border-width: 9px 7px 0; border-style: solid; border-color: #fff transparent; display: block; width: 0; z-index: 1; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 20px; }
        #result-area { display: none; margin-top: 30px; padding: 40px; background: #fff; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .score-circle { width: 150px; height: 150px; background: #ffb703; color: #fff; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 20px auto; }
        .score-number { font-size: 3.5rem; font-weight: 800; line-height: 1; }
        .tag { background: #eee; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; color: #555; margin: 5px; display:inline-block;}
        .tag.highlight { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <h2>ğŸš€ è¼‰å…¥é›™å¼•æ“ AI...</h2>
        <p id="loading-status">æ­£åœ¨å–šé†’ Coco-SSD (ç‰©ä»¶è­˜åˆ¥)...</p>
    </div>

    <main class="container">
        <h1>ğŸ¶ äººå¯µé…å° v3.9</h1>
        <p>ç²¾æº–ç‰ˆ - è­˜åˆ†äººè²“ç‹—</p>

        <div class="grid">
            <div>
                <h3>1. ä¸»äººç›¸ ğŸ‘±</h3>
                <div class="preview-box" id="box1" onclick="document.getElementById('upload1').click()">
                    <div id="bubble1" class="bubble"></div>
                    <div class="img-container">
                        <span style="color:#ccc; font-size:2rem;">+</span>
                        <img id="img1" style="display:none;" crossorigin="anonymous">
                    </div>
                </div>
                <input type="file" id="upload1" accept="image/*" onchange="checkHuman(event)" style="display:none;">
            </div>
            <div>
                <h3>2. ç‹—ç‹—ç›¸ ğŸ¶</h3>
                <div class="preview-box" id="box2" onclick="document.getElementById('upload2').click()">
                     <div id="bubble2" class="bubble"></div>
                     <div class="img-container">
                        <span style="color:#ccc; font-size:2rem;">+</span>
                        <img id="img2" style="display:none;" crossorigin="anonymous">
                     </div>
                </div>
                <input type="file" id="upload2" accept="image/*" onchange="checkDog(event)" style="display:none;">
            </div>
        </div>

        <button id="analyzeBtn" onclick="analyzeSimilarity()" disabled style="width: 100%; font-size: 1.2rem; padding: 20px;">ğŸ¤– ç«‹å³åˆ†æ</button>
        
        <div id="result-area">
            <div class="score-circle">
                <span class="score-number" id="score">0</span>
                <span>% ç›¸ä¼¼</span>
            </div>
            <h3 id="comment">...</h3>
            <div id="tags"></div>
            <br>
            <button onclick="window.location.reload()" class="secondary outline">ğŸ”„ å†ç©ä¸€æ¬¡</button>
        </div>
    </main>

    <script>
        let mobilenetModel;
        let cocoSsdModel;
        const colorThief = new ColorThief();
        const btn = document.getElementById('analyzeBtn');
        let humanStatus = { isHard: false };
        let dogStatus = { isHard: false };

        async function initAI() {
            try {
                // Coco-SSD æ¯”è¼ƒå¤§ï¼Œå…ˆ Load
                cocoSsdModel = await cocoSsd.load();
                console.log("âœ… Coco-SSD Ready");
                
                document.getElementById('loading-status').innerText = 'è¼‰å…¥ MobileNet (ç‰¹å¾µæå–)...';
                mobilenetModel = await mobilenet.load();
                console.log("âœ… MobileNet Ready");
                
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (e) {
                alert("è¼‰å…¥å¤±æ•—ï¼Œè«‹ Refresh å†è©¦"); console.error(e);
            }
        }
        initAI();

        // Check Human (Coco-SSD)
        async function checkHuman(event) {
            await loadFile(event, 'img1', 'box1', 'bubble1');
            const img = document.getElementById('img1');
            const bubble = document.getElementById('bubble1');
            humanStatus.isHard = false;
            bubble.style.display = 'none';
            btn.disabled = true;

            setTimeout(async () => {
                if (!cocoSsdModel) return;

                const detections = await cocoSsdModel.detect(img);
                console.log("Human:", detections);

                const hasPerson = detections.some(d => d.class === 'person' && d.score > 0.4);
                const hasAnimal = detections.some(d => (d.class === 'dog' || d.class === 'cat' || d.class === 'horse') && d.score > 0.4);

                if (hasAnimal) {
                    showBubble(bubble, "ğŸ¶ å–‚å–‚ï¼å‘¢é‚Šä¿‚æ”¾ä¸»äººç›¸æ¶ï¼", true, true);
                    return;
                }

                if (!hasPerson) {
                    showBubble(bubble, "ğŸ¤” æµå””åˆ°äººæ¨£å–ï¼Ÿ", true, true);
                    return;
                }
                
                const personCount = detections.filter(d => d.class === 'person' && d.score > 0.4).length;
                if (personCount > 1) {
                    showBubble(bubble, "ğŸ‘¥ å¤ªå¤šäººå•¦ï¼AI æƒ³ä¸€å°ä¸€å°ˆæ³¨ç‡ï¼", true, true);
                    return;
                }

                showBubble(bubble, "âœ… é€™å¼µç›¸å¥½æ­£ï¼", false, false);
                checkReady();
            }, 300);
        }

        // Check Dog (Coco-SSD)
        async function checkDog(event) {
            await loadFile(event, 'img2', 'box2', 'bubble2');
            const img = document.getElementById('img2');
            const bubble = document.getElementById('bubble2');
            dogStatus.isHard = false;
            bubble.style.display = 'none';
            btn.disabled = true;

            setTimeout(async () => {
                if (!cocoSsdModel) return;

                const detections = await cocoSsdModel.detect(img);
                console.log("Dog:", detections);

                const hasPerson = detections.some(d => d.class === 'person' && d.score > 0.5);
                const hasDog = detections.some(d => d.class === 'dog' && d.score > 0.4);
                const hasCat = detections.some(d => d.class === 'cat' && d.score > 0.4);

                if (hasPerson) {
                    showBubble(bubble, "ğŸ¶ ä¸»å­ç¨ç…§å¥½å•²å–ï¼å””å¥½æ¶é¡ï¼", true, true);
                    return;
                }
                if (hasCat) {
                    showBubble(bubble, "ğŸ± å–µï¼Ÿå‘¢åº¦ä¿‚ç‹—ç‹—å°ˆå€å–ï¼", true, true);
                    return;
                }

                if (!hasDog) {
                    showBubble(bubble, "ğŸ¶ å””å¤ªä¼¼ç‹—å–... ä¸éæˆ‘åœ°ç…§è©¦ä¸‹å•¦ï¼", true, false);
                    dogStatus.isHard = true;
                } else {
                    showBubble(bubble, "âœ… æ”¶åˆ°ï¼ç¢ºèªä¿‚ç‹—ç‹—ï¼", false, false);
                }
                checkReady();
            }, 300);
        }

        function showBubble(el, msg, isWarning, isError) {
            el.innerText = msg; el.style.display = 'block';
            if (isError) { el.style.border = '2px solid #d32f2f'; el.style.color = '#d32f2f'; }
            else if (isWarning) { el.style.border = '2px solid #fbc02d'; el.style.color = '#f57f17'; } 
            else { el.style.border = '2px solid #2e7d32'; el.style.color = '#2e7d32'; }
        }

        function loadFile(event, imgId, boxId) {
            return new Promise(resolve => {
                const output = document.getElementById(imgId);
                const container = document.querySelector(`#${boxId} .img-container`);
                const plusSign = container.querySelector('span');
                if (event.target.files && event.target.files[0]) {
                    output.src = URL.createObjectURL(event.target.files[0]);
                    output.onload = () => { URL.revokeObjectURL(output.src); resolve(); }
                    plusSign.style.display = 'none'; output.style.display = 'block';
                }
            });
        }

        function checkReady() {
            const bubble1 = document.getElementById('bubble1');
            const bubble2 = document.getElementById('bubble2');
            const isErr1 = bubble1.style.borderColor === 'rgb(211, 47, 47)';
            const isErr2 = bubble2.style.borderColor === 'rgb(211, 47, 47)'; 
            const img1 = document.getElementById('img1').style.display === 'block';
            const img2 = document.getElementById('img2').style.display === 'block';
            if (img1 && img2 && !isErr1 && !isErr2) btn.disabled = false;
        }
        
        async function analyzeSimilarity() {
            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');
            btn.setAttribute("aria-busy", "true");
            
            setTimeout(async () => {
                const activation1 = mobilenetModel.infer(img1, true);
                const activation2 = mobilenetModel.infer(img2, true);
                const rawDist = cosineSimilarity(activation1, activation2);
                let score = mapRange(rawDist, 0.35, 0.75, 100, 10);
                let bonusTags = [];
                if (humanStatus.isHard && dogStatus.isHard) { score += 5; bonusTags.push("ğŸ˜ å…©å€‹éƒ½å’å‹"); }
                const c1 = colorThief.getColor(img1); const c2 = colorThief.getColor(img2);
                const colorDist = Math.sqrt(Math.pow(c1[0]-c2[0],2) + Math.pow(c1[1]-c2[1],2) + Math.pow(c1[2]-c2[2],2));
                if (colorDist < 60) { score += 5; bonusTags.push("ğŸ¨ è‰²ç³»å¥½è¥¯"); }
                score = Math.min(99, Math.max(10, Math.round(score)));
                showResult(score, bonusTags);
                btn.setAttribute("aria-busy", "false");
            }, 100);
        }

        function showResult(score, tags) {
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('score').innerText = score;
            const comment = document.getElementById('comment');
            if(score > 90) comment.innerText = "ğŸ˜± å¤±æ•£å¤šå¹´æ—¢è¦ªäººï¼";
            else if(score > 75) comment.innerText = "â¤ï¸ é»˜å¥‘åè¶³ï¼Œå¤©ç”Ÿä¸€å°ï¼";
            else if(score > 60) comment.innerText = "ğŸ˜ å¹¾æœ‰çˆ¶å­/æ¯å¥³ç›¸ï¼";
            else comment.innerText = "ğŸ˜‚ é›–ç„¶å””ä¼¼ï¼Œä½†å‹åœ¨æœ‰æ„›ï¼";
            const tagContainer = document.getElementById('tags'); tagContainer.innerHTML = "";
            tags.forEach(t => tagContainer.innerHTML += `<span class="tag highlight">${t}</span>`);
        }

        function cosineSimilarity(t1, t2) {
            const v1 = t1.dataSync(); const v2 = t2.dataSync();
            let dotProduct = 0, normA = 0, normB = 0;
            for (let i = 0; i < v1.length; i++) { dotProduct += v1[i] * v2[i]; normA += v1[i] * v1[i]; normB += v2[i] * v2[i]; }
            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }
        function mapRange(value, low1, high1, low2, high2) {
            return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
        }
    </script>
</body>
</html>
