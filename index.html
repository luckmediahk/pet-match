<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ äººå¯µé…å°åˆ†æå„€ (å®˜æ–¹æ­£å¼ç‰ˆ)</title>
    <!-- å¼•å…¥ Pico.css (æ¨£å¼) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <!-- å¼•å…¥ TensorFlow.js åŒ MobileNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    <style>
        body { padding: 20px; text-align: center; max-width: 800px; margin: 0 auto; background-color: #fdfbf7; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        h1 { color: #4a4a4a; margin-bottom: 0.5rem; }
        
        .preview-box { 
            width: 180px; height: 180px; 
            border: 3px solid #eee; 
            margin: 10px auto; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; background: #fff; border-radius: 50%; /* åœ“å½¢é ­åƒ */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .preview-box:hover { transform: scale(1.05); border-color: #ffb703; }
        img { width: 100%; height: 100%; object-fit: cover; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

        /* çµæœå±•ç¤ºå€ */
        #result-area { 
            display: none; 
            margin-top: 30px; 
            padding: 40px; 
            background: linear-gradient(135deg, #fff 0%, #fff8e1 100%); 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .score-circle {
            width: 150px; height: 150px;
            background: #ffb703;
            color: #fff;
            border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 0 auto 20px auto;
            box-shadow: 0 5px 15px rgba(255, 183, 3, 0.4);
        }
        .score-number { font-size: 3.5rem; font-weight: 800; line-height: 1; }
        .score-label { font-size: 1rem; opacity: 0.9; }
        
        .comment { font-size: 1.2rem; color: #555; font-weight: bold; margin-bottom: 20px; }
        
        /* é›£åº¦é¸æ“‡ (ç°¡åŒ–ç‰ˆ) */
        .settings-panel { 
            text-align: left; background: #fff; padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 0.9rem; border: 1px solid #eee;
        }
        details summary { cursor: pointer; color: #888; }
    </style>
</head>
<body>

    <main class="container">
        <hgroup>
            <h1>ğŸ¶ äººå¯µé…å°åˆ†æå„€</h1>
            <p>AI å¹«ä½ æ¸¬ä¸‹ï¼Œä½ åŒä¸»å­åˆ°åº•æœ‰å¹¾ä¼¼æ¨£ï¼Ÿ (100% ç§éš±ä¿è­·)</p>
        </hgroup>

        <!-- ä¸Šè¼‰å€ -->
        <div class="grid">
            <div>
                <h3>1. ä¸»äººç›¸ ğŸ‘±</h3>
                <div class="preview-box" id="box1" onclick="document.getElementById('upload1').click()" style="cursor: pointer;">
                    <span style="color:#ccc; font-size:2rem;">+</span>
                </div>
                <input type="file" id="upload1" accept="image/*" onchange="loadFile(event, 'img1', 'box1')" style="display:none;">
                <button class="outline" onclick="document.getElementById('upload1').click()" style="font-size:0.8rem; padding: 5px 15px;">ä¸Šè¼‰ç›¸ç‰‡</button>
                <img id="img1" style="display:none;" crossorigin="anonymous"> 
            </div>
            <div>
                <h3>2. å¯µç‰©ç›¸ ğŸ±</h3>
                <div class="preview-box" id="box2" onclick="document.getElementById('upload2').click()" style="cursor: pointer;">
                     <span style="color:#ccc; font-size:2rem;">+</span>
                </div>
                <input type="file" id="upload2" accept="image/*" onchange="loadFile(event, 'img2', 'box2')" style="display:none;">
                <button class="outline" onclick="document.getElementById('upload2').click()" style="font-size:0.8rem; padding: 5px 15px;">ä¸Šè¼‰ç›¸ç‰‡</button>
                <img id="img2" style="display:none;" crossorigin="anonymous">
            </div>
        </div>

        <!-- é€²éšè¨­å®š (é»˜èªæ”¶åŸ‹) -->
        <details class="settings-panel">
            <summary>âš™ï¸ é€²éšé¸é … (å¦‚æˆ´çœ¼é¡/å´é¢è«‹é»æ­¤)</summary>
            <p>å¦‚æœç›¸ç‰‡æœ‰é®æ“‹ (å¦‚æˆ´å¢¨é¡ã€å£ç½©) æˆ–å¤§å´é¢ï¼Œè«‹é¸æ“‡ã€Œå›°é›£æ¨¡å¼ã€ï¼ŒAI æœƒèª¿æ•´ç®—æ³•ã€‚</p>
            <label>
                <input type="checkbox" id="isHardMode"> 
                <strong>é–‹å•Ÿå›°é›£æ¨¡å¼ (é»‘è¶…/å´é¢/å…‰ç·šæš—)</strong>
            </label>
        </details>

        <br>
        <button id="analyzeBtn" onclick="analyzeSimilarity()" disabled style="width: 100%; font-size: 1.2rem; padding: 20px;">ğŸ¤– ç«‹å³åˆ†æç›¸ä¼¼åº¦</button>
        
        <!-- çµæœå±•ç¤º -->
        <div id="result-area">
            <div class="score-circle">
                <span class="score-number" id="score">0</span>
                <span class="score-label">% ç›¸ä¼¼</span>
            </div>
            <div class="comment" id="comment">æ­£åœ¨è§£è®€åŸºå› å¯†ç¢¼...</div>
            <button onclick="window.location.reload()" class="secondary outline">ğŸ”„ å†ç©ä¸€æ¬¡</button>
            <br><br>
            <small style="color:#aaa;">Share to Instagram Story ğŸ“¸</small>
        </div>

    </main>

    <script>
        let model;
        const btn = document.getElementById('analyzeBtn');

        // 1. è¼‰å…¥æ¨¡å‹
        async function loadModel() {
            console.log("Loading Model...");
            try {
                model = await mobilenet.load(); // è¼‰å…¥ MobileNet
                console.log("Model Loaded!");
                btn.innerText = "âœ¨ ç«‹å³åˆ†æç›¸ä¼¼åº¦";
                btn.disabled = false;
            } catch (e) {
                console.error(e);
                btn.innerText = "âš ï¸ ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹åˆ·æ–°é é¢";
            }
        }
        loadModel();

        // åœ–ç‰‡é è¦½
        function loadFile(event, imgId, boxId) {
            const output = document.getElementById(imgId);
            const box = document.getElementById(boxId);
            if (event.target.files && event.target.files[0]) {
                output.src = URL.createObjectURL(event.target.files[0]);
                output.onload = () => { URL.revokeObjectURL(output.src) }
                box.innerHTML = ""; 
                box.appendChild(output.cloneNode());
                box.children[0].style.display = "block";
                document.getElementById('result-area').style.display = 'none';
            }
        }

        // æ ¸å¿ƒé‚è¼¯
        async function analyzeSimilarity() {
            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');
            const isHardMode = document.getElementById('isHardMode').checked;

            if (!img1.src || !img2.src || img1.src == "" || img2.src == "") {
                alert("è«‹å…ˆä¸Šè¼‰å…©å¼µç›¸ï¼");
                return;
            }

            btn.setAttribute("aria-busy", "true");
            btn.innerText = "AI é‹ç®—ä¸­...";

            // å»¶é²åŸ·è¡Œä»¥å…å¡æ­» UI
            setTimeout(async () => {
                try {
                    // 1. ç²å–ç‰¹å¾µå‘é‡
                    const activation1 = model.infer(img1, true);
                    const activation2 = model.infer(img2, true);
                    
                    // 2. è¨ˆç®—åŸå§‹è·é›¢ (0 ~ 1+)
                    const rawDist = cosineSimilarity(activation1, activation2);
                    console.log("Raw Distance:", rawDist); // Debug ç”¨

                    // 3. --- é»ƒé‡‘å…¬å¼ (Golden Formula) ---
                    // æ ¹æ“šä½ æä¾›çš„æ•¸æ“šï¼š0.405 æ˜¯æœ€å¥½ (å°æ‡‰ ~95åˆ†)ï¼Œ0.72 æ˜¯æœ€å·® (å°æ‡‰ ~10åˆ†)
                    // æˆ‘åœ°ç”¨ mapRange åšç·šæ€§æŠ•å°„
                    let finalScore = mapRange(rawDist, 0.35, 0.75, 98, 10);
                    
                    // 4. é›£åº¦æ‡²ç½°
                    if (isHardMode) {
                        // å¦‚æœä¿‚ Hard Modeï¼Œå› ç‚º AI æº–åº¦ä¸‹é™ï¼Œæˆ‘åœ°ä¿å®ˆå°‘å°‘ï¼Œæ‰£åˆ†æˆ–åŠ åˆ†ä»¤ä½¢è¶¨å‘ä¸­é–“å€¼
                        // é€™è£¡ç°¡å–®è™•ç†ï¼šæ‰£ 10% ä¿¡å¿ƒåˆ†
                        finalScore = finalScore * 0.9; 
                    }

                    // 5. é‚Šç•Œè™•ç† (å””å¥½çˆ†åˆ†)
                    finalScore = Math.round(finalScore);
                    if (finalScore > 99) finalScore = 99;
                    if (finalScore < 5) finalScore = Math.floor(Math.random() * 10) + 5; // ä¿¾å°‘å°‘åŒæƒ…åˆ†

                    // 6. é¡¯ç¤ºçµæœ
                    showResult(finalScore);

                } catch (error) {
                    console.error(error);
                    alert("åˆ†æå¤±æ•—ï¼Œè«‹è©¦ä¸‹ç”¨å…¶ä»–ç›¸ç‰‡");
                }
                btn.setAttribute("aria-busy", "false");
                btn.innerText = "âœ¨ ç«‹å³åˆ†æç›¸ä¼¼åº¦";
            }, 100);
        }

        function showResult(score) {
            const resultArea = document.getElementById('result-area');
            const scoreText = document.getElementById('score');
            const commentText = document.getElementById('comment');

            resultArea.style.display = 'block';
            
            // æ•¸å­—è·³å‹•æ•ˆæœ
            let current = 0;
            const timer = setInterval(() => {
                current += 2;
                if (current >= score) {
                    current = score;
                    clearInterval(timer);
                }
                scoreText.innerText = current;
                
                // å‹•æ…‹è©•èª
                if(current > 90) commentText.innerText = "ğŸ˜± å¤©å•Šï¼é€™æ˜¯å¤±æ•£å¤šå¹´çš„å…„å¼Ÿå§ï¼Ÿ";
                else if(current > 80) commentText.innerText = "â¤ï¸ é»˜å¥‘åè¶³ï¼çµ•å°ä¿‚è¦ªç”Ÿæ—¢ï¼";
                else if(current > 60) commentText.innerText = "ğŸ˜ çœ¼ç¥æœ‰å¹¾åˆ†ç›¸ä¼¼ï¼Œå¹¾æœ‰çˆ¶å­ç›¸ï¼";
                else if(current > 40) commentText.innerText = "ğŸ¤” å¤–è¡¨å””ä¼¼ï¼Œä½†æ°£è³ªæ­å¤ ï¼";
                else commentText.innerText = "ğŸ˜‚ é›–ç„¶å””ä¼¼æ¨£ï¼Œä½†æ„›æ„ä¿‚ 100% æ—¢ï¼";
                
                // è®Šè‰²
                if(current > 80) document.querySelector('.score-circle').style.background = "#38b000"; // Green
                else if(current < 50) document.querySelector('.score-circle').style.background = "#e63946"; // Red
                else document.querySelector('.score-circle').style.background = "#ffb703"; // Yellow

            }, 20);
        }

        // æ•¸å­¸å·¥å…·
        function cosineSimilarity(t1, t2) {
            const v1 = t1.dataSync();
            const v2 = t2.dataSync();
            let dotProduct = 0, normA = 0, normB = 0;
            for (let i = 0; i < v1.length; i++) {
                dotProduct += v1[i] * v2[i];
                normA += v1[i] * v1[i];
                normB += v2[i] * v2[i];
            }
            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }

        function mapRange(value, low1, high1, low2, high2) {
            return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
        }
    </script>
</body>
</html>
