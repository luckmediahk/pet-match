<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ äººå¯µé…å° v4.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>

    <style>
        :root { --primary: #FFB703; --secondary: #219EBC; --bg: #FFF8F0; }
        body { 
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif; 
            background-color: var(--bg); color: #333; margin: 0; padding: 20px;
            background-image: radial-gradient(#FFB703 15%, transparent 16%), radial-gradient(#FFB703 15%, transparent 16%);
            background-size: 60px 60px; background-position: 0 0, 30px 30px;
        }
        
        .container { max-width: 600px; margin: 0 auto; background: rgba(255,255,255,0.95); padding: 30px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        h1 { color: #023047; margin-bottom: 5px; }
        p.subtitle { color: #8E9AAF; font-size: 0.9rem; margin-top: 0; }

        .preview-box { 
            width: 140px; height: 140px; 
            border: 4px solid #fff; outline: 3px dashed #ddd; margin: 10px auto; 
            position: relative; cursor: pointer;
            background: #f0f0f0; border-radius: 50%; 
        }
        .img-container { width: 100%; height: 100%; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        img { width: 100%; height: 100%; object-fit: cover; }
        
        .bubble {
            background: #fff; color: #333; padding: 10px 15px; border-radius: 15px;
            font-size: 0.8rem; font-weight: bold; position: absolute; top: -50px; right: -70px; width: 150px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid #333; display: none; z-index: 100;
        }

        .grid { display: flex; justify-content: space-around; gap: 10px; margin: 20px 0; }
        
        button.action-btn {
            background: var(--secondary); color: white; border: none; padding: 15px 40px;
            font-size: 1.2rem; border-radius: 50px; cursor: pointer; width: 100%;
            font-family: 'Fredoka', sans-serif; box-shadow: 0 5px 15px rgba(33, 158, 188, 0.4);
            transition: all 0.3s;
        }
        button.action-btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
        
        /* Personality Check Modal */
        #personality-check {
            display: none; background: #E0F7FA; padding: 20px; border-radius: 20px; text-align: center; margin-top: 20px; border: 2px solid #B2EBF2;
        }
        .trait-tags { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 15px 0; }
        .trait-tag {
            background: #fff; border: 2px solid #ddd; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; color: #777; transition: all 0.2s;
        }
        .trait-tag.active {
            background: #FFB703; border-color: #FB8500; color: #fff; transform: scale(1.1); box-shadow: 0 5px 10px rgba(255, 183, 3, 0.4);
        }
        
        /* Result Card */
        #result-card {
            display: none; margin-top: 30px; padding: 30px; background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
            border-radius: 20px; border: 1px solid #eee; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            text-align: center;
        }
        .score-big { font-size: 5rem; font-weight: 800; color: var(--secondary); line-height: 1; margin: 10px 0; }
        .verdict { font-size: 1.3rem; font-weight: bold; color: #FB8500; margin-bottom: 20px; }
        
        /* Progress Bars */
        .stat-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 0.9rem; }
        .stat-label { width: 100px; text-align: right; margin-right: 10px; font-weight: bold; color: #555; }
        .progress-bg { flex-grow: 1; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: #219EBC; width: 0%; transition: width 1s ease-out; }
        .stat-val { width: 40px; text-align: left; margin-left: 10px; color: #888; }
        
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 3rem;">ğŸ¶</div>
        <h3 style="color:#555;">æ­£åœ¨å–šé†’ AI ç‹—ç‹—...</h3>
    </div>

    <div class="container">
        <h1>ğŸ¾ äººå¯µé…å° v4.3</h1>
        <p class="subtitle">AI æ™ºèƒ½åˆ†æ â€¢ æ€§æ ¼æ·±åº¦é…å°</p>

        <div class="grid">
            <div style="text-align:center;">
                <span style="font-size:1.5rem;">ğŸ‘±</span>
                <div class="preview-box" id="box1" onclick="document.getElementById('upload1').click()">
                    <div id="bubble1" class="bubble"></div>
                    <div class="img-container">
                        <span style="color:#ddd; font-size:3rem;">+</span>
                        <img id="img1" style="display:none;" crossorigin="anonymous">
                    </div>
                </div>
                <input type="file" id="upload1" accept="image/*" onchange="checkHuman(event)" style="display:none;">
            </div>
            <div style="text-align:center;">
                <span style="font-size:1.5rem;">ğŸ¶</span>
                <div class="preview-box" id="box2" onclick="document.getElementById('upload2').click()">
                     <div id="bubble2" class="bubble"></div>
                     <div class="img-container">
                        <span style="color:#ddd; font-size:3rem;">+</span>
                        <img id="img2" style="display:none;" crossorigin="anonymous">
                     </div>
                </div>
                <input type="file" id="upload2" accept="image/*" onchange="checkDog(event)" style="display:none;">
            </div>
        </div>

        <!-- Step 1 Button -->
        <button id="preAnalyzeBtn" class="action-btn" onclick="preAnalyze()" disabled>âœ¨ ç«‹å³åˆ†æ</button>

        <!-- Step 2: Personality Check -->
        <div id="personality-check">
            <h3>ğŸ¶ ç™¼ç¾å“ç¨®ï¼š<span id="breed-name" style="color:#FB8500;">...</span></h3>
            <p>ä½¢ä¿‚å’ªæœ‰ä»¥ä¸‹ç‰¹å¾µï¼Ÿ(é»æ“Šç¢ºèª)</p>
            <div class="trait-tags" id="trait-container">
                <!-- Tags will be injected here -->
            </div>
            <button class="action-btn" onclick="finalAnalyze()" style="background:#FFB703; color:#000; margin-top:15px;">âœ… ä¿‚å‘€ï¼å‡ºå ±å‘Šï¼</button>
        </div>
        
        <!-- Step 3: Result -->
        <div id="result-card">
            <p style="color:#888; margin:0;">AI æ·±åº¦åˆ†æçµæœ</p>
            <div class="score-big"><span id="score">0</span>%</div>
            <div class="verdict" id="comment">...</div>
            
            <div style="background:#f9f9f9; padding:20px; border-radius:15px; margin-top:20px;">
                <h4 style="margin-top:0; color:#555;">ğŸ“Š AI åˆ†æå ±å‘Š</h4>
                
                <div class="stat-row">
                    <div class="stat-label">ğŸ‘€ äº”å®˜ç¥éŸ»</div>
                    <div class="progress-bg"><div class="progress-fill" id="bar1"></div></div>
                    <div class="stat-val" id="val1">0%</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">ğŸ¨ æ¯›è‰²é«®è‰²</div>
                    <div class="progress-bg"><div class="progress-fill" id="bar2"></div></div>
                    <div class="stat-val" id="val2">0%</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">ğŸ§  æ°£å ´ç›¸è¿‘</div>
                    <div class="progress-bg"><div class="progress-fill" id="bar3"></div></div>
                    <div class="stat-val" id="val3">0%</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">ğŸ¤ æ€§æ ¼åŠ æˆ</div>
                    <div class="progress-bg"><div class="progress-fill" id="bar4" style="background:#FFB703;"></div></div>
                    <div class="stat-val" id="val4">0%</div>
                </div>
            </div>
            
            <div style="font-size:0.8rem; color:#999; margin-top:20px;">
                ğŸ“¸ Cap åœ– Share å» IG Story å•¦ï¼
            </div>
        </div>
        
        <button onclick="window.location.reload()" style="background:transparent; color:#999; border:none; margin-top:20px; cursor:pointer; text-decoration:underline; display:none;" id="restartBtn">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>

    <script>
        let mobilenetModel, cocoSsdModel;
        const colorThief = new ColorThief();
        let currentBreed = "";
        let personalityScore = 0;
        let img1Data = {name:'', size:0}, img2Data = {name:'', size:0};

        // Breed Data (Traits)
        const breedTraits = {
            'retriever': ['ç†±æƒ… â¤ï¸', 'ç‚ºé£Ÿ ğŸ–', 'é»èº« ğŸ¤—'],
            'poodle': ['è°æ˜ ğŸ§ ', 'æ´»æ½‘ ğŸ¾', 'æœ‰æ½”ç™– âœ¨'],
            'terrier': ['ç¡¬é ¸ ğŸ˜¤', 'å¥½å‹• âš¡', 'å‹‡æ•¢ ğŸ¦'],
            'husky': ['æ‹†å®¶ ğŸšï¸', 'è¡¨æƒ…åŒ… ğŸ¤ª', 'å¤šé‡è¬› ğŸ—£ï¸'],
            'pug': ['æ„›è¨“è¦º ğŸ’¤', 'æ‰“é¼»é¼¾ ğŸ”Š', 'æ¨‚è§€ ğŸ˜„'],
            'default': ['å¯æ„› ğŸ¥°', 'ä¹–å·§ ğŸ˜‡', 'è²ªç© ğŸ¾']
        };

        async function initAI() {
            try {
                cocoSsdModel = await cocoSsd.load();
                mobilenetModel = await mobilenet.load();
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (e) { alert("AI è¼‰å…¥å¤±æ•—"); }
        }
        initAI();

        function loadFile(event, imgId, boxId) {
            return new Promise(resolve => {
                const output = document.getElementById(imgId);
                const file = event.target.files[0];
                if (file) {
                    if(imgId === 'img1') img1Data = { name: file.name, size: file.size };
                    if(imgId === 'img2') img2Data = { name: file.name, size: file.size };
                    output.src = URL.createObjectURL(file);
                    output.onload = () => { resolve(); }
                    output.style.display = 'block';
                    document.querySelector(`#${boxId} span`).style.display = 'none';
                }
            });
        }

        async function checkHuman(event) {
            await loadFile(event, 'img1', 'box1');
            const img = document.getElementById('img1');
            const bubble = document.getElementById('bubble1');
            bubble.style.display = 'none';
            setTimeout(async () => {
                if (!cocoSsdModel) return;
                const detections = await cocoSsdModel.detect(img);
                const hasDog = detections.some(d => d.class === 'dog' && d.score > 0.4);
                if (hasDog) { showBubble(bubble, "ğŸ¶ å–‚å–‚ï¼å‘¢é‚Šä¿‚æ”¾ä¸»äººç›¸æ¶ï¼", true); }
                else { showBubble(bubble, "âœ… é€™å¼µç›¸å¥½æ­£ï¼", false); }
                checkReady();
            }, 300);
        }

        async function checkDog(event) {
            await loadFile(event, 'img2', 'box2');
            const img = document.getElementById('img2');
            const bubble = document.getElementById('bubble2');
            bubble.style.display = 'none';
            setTimeout(async () => {
                if (!cocoSsdModel) return;
                const detections = await cocoSsdModel.detect(img);
                const hasPerson = detections.some(d => d.class === 'person' && d.score > 0.5);
                const hasCat = detections.some(d => d.class === 'cat' && d.score > 0.4);
                if (hasPerson) { showBubble(bubble, "ğŸ¶ ä¸»å­ç¨ç…§å¥½å•²å–ï¼", true); }
                else if (hasCat) { showBubble(bubble, "ğŸ± å–µï¼Ÿå‘¢åº¦ä¿‚ç‹—ç‹—å°ˆå€å–ï¼", true); }
                else { showBubble(bubble, "âœ… æ”¶åˆ°ï¼ç¢ºèªä¿‚ç‹—ç‹—ï¼", false); }
                checkReady();
            }, 300);
        }

        function showBubble(el, msg, isWarning) {
            el.innerText = msg; el.style.display = 'block';
            el.style.border = isWarning ? '2px solid #fbc02d' : '2px solid #2e7d32';
            el.style.color = isWarning ? '#f57f17' : '#2e7d32';
        }

        function checkReady() {
            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');
            if (img1.style.display === 'block' && img2.style.display === 'block') {
                document.getElementById('preAnalyzeBtn').disabled = false;
            }
        }

        // Step 1: Pre-Analyze (Breed Detection)
        async function preAnalyze() {
            const btn = document.getElementById('preAnalyzeBtn');
            const img2 = document.getElementById('img2');
            btn.innerText = "ğŸ” è­˜åˆ¥å“ç¨®ä¸­...";
            btn.disabled = true;

            const predictions = await mobilenetModel.classify(img2, 3);
            currentBreed = predictions[0].className.split(',')[0];
            
            // Find matched traits
            let traits = breedTraits['default'];
            for (const key in breedTraits) {
                if (currentBreed.toLowerCase().includes(key)) {
                    traits = breedTraits[key];
                    break;
                }
            }

            // Show UI
            document.getElementById('breed-name').innerText = currentBreed;
            const container = document.getElementById('trait-container');
            container.innerHTML = "";
            traits.forEach(t => {
                container.innerHTML += `<div class="trait-tag" onclick="toggleTrait(this)">${t}</div>`;
            });
            
            btn.style.display = 'none';
            document.getElementById('personality-check').style.display = 'block';
        }

        function toggleTrait(el) {
            el.classList.toggle('active');
            // Calculate bonus score
            const activeCount = document.querySelectorAll('.trait-tag.active').length;
            personalityScore = activeCount * 5; // Each trait +5%
        }

        // Step 2: Final Analyze
        async function finalAnalyze() {
            document.getElementById('personality-check').style.display = 'none';
            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');

            // 1. MobileNet Similarity
            const act1 = mobilenetModel.infer(img1, true);
            const act2 = mobilenetModel.infer(img2, true);
            const rawDist = cosineSimilarity(act1, act2); // 0 to 1
            
            // 2. Color Match
            const c1 = colorThief.getColor(img1);
            const c2 = colorThief.getColor(img2);
            const colorDist = Math.sqrt(Math.pow(c1[0]-c2[0],2) + Math.pow(c1[1]-c2[1],2) + Math.pow(c1[2]-c2[2],2));
            
            // 3. Random Seed
            function simpleHash(str) { let h=0;for(let i=0;i<str.length;i++){h=((h<<5)-h)+str.charCodeAt(i);h|=0;}return Math.abs(h); }
            const seed = simpleHash(img1Data.name + img1Data.size + img2Data.name + img2Data.size);
            const r1 = (seed % 10);
            
            // Scores for Progress Bars
            let s1 = Math.round(mapRange(rawDist, 0.2, 0.8, 40, 95)) + r1; // Similarity
            let s2 = Math.max(20, 100 - Math.round(colorDist / 3)); // Color
            let s3 = 60 + (seed % 30); // Vibe (Random but deterministic)
            let s4 = personalityScore; // Personality Bonus
            
            let totalScore = Math.round((s1 * 0.4) + (s2 * 0.3) + (s3 * 0.2) + s4);
            totalScore = Math.min(99, Math.max(10, totalScore));

            // Set Values
            setBar('bar1', 'val1', s1);
            setBar('bar2', 'val2', s2);
            setBar('bar3', 'val3', s3);
            setBar('bar4', 'val4', s4 > 0 ? `+${s4}%` : '0%', s4); // Display +% for bonus

            document.getElementById('score').innerText = totalScore;
            
            // Verdict
             const comments = [
                { min: 90, text: "ğŸ˜± 99%ä¿‚å¤±æ•£å·¦æ—¢è¦ªäººï¼" },
                { min: 80, text: "â¤ï¸ ä¼¼éåŒä¸€å€‹ç¥–å®—ï¼" },
                { min: 60, text: "ğŸ˜ å¯èƒ½ä¸Šä¸–ä½éš”é›¢æ‘ï¼" },
                { min: 40, text: "ğŸ¤” ä½ åœ°ä¿‚ç•°æ¥µç›¸å¸ï¼" },
                { min: 0,  text: "ğŸ˜‚ å””ä¼¼æ¨£ï¼Œä½†å‹åœ¨æœ‰æ„›ï¼" }
            ];
            document.getElementById('comment').innerText = comments.find(c => totalScore >= c.min).text;
            
            document.getElementById('result-card').style.display = 'block';
            document.getElementById('restartBtn').style.display = 'block';
        }

        function setBar(barId, valId, val, rawVal) {
            const v = rawVal !== undefined ? rawVal : val; // Use rawVal for width calculation if provided
            setTimeout(() => {
                document.getElementById(barId).style.width = Math.min(100, v) + '%';
                document.getElementById(valId).innerText = typeof val === 'string' ? val : val + '%';
            }, 100);
        }

        function cosineSimilarity(t1, t2) {
            const v1 = t1.dataSync(); const v2 = t2.dataSync();
            let dotProduct = 0, normA = 0, normB = 0;
            for (let i = 0; i < v1.length; i++) { dotProduct += v1[i] * v2[i]; normA += v1[i] * v1[i]; normB += v2[i] * v2[i]; }
            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }
        function mapRange(value, low1, high1, low2, high2) {
            return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
        }
    </script>
</body>
</html>
