<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ äººå¯µé…å°åˆ†æå„€ (v2.0 Color Edition)</title>
    <!-- å¼•å…¥ Pico.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <!-- å¼•å…¥ TensorFlow.js & MobileNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    <!-- å¼•å…¥ Color Thief (æ‰è‰²ç”¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>

    <style>
        /* (æ¨£å¼ç…§èˆŠï¼ŒåŠ å°‘å°‘ Color é¡¯ç¤º) */
        body { padding: 20px; text-align: center; max-width: 800px; margin: 0 auto; background-color: #fdfbf7; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        .preview-box { 
            width: 180px; height: 180px; 
            border: 3px solid #eee; margin: 10px auto; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; background: #fff; border-radius: 50%; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative;
        }
        img { width: 100%; height: 100%; object-fit: cover; }
        
        /* é¡è‰²æ³¢æ³¢ */
        .color-dot {
            width: 40px; height: 40px; border-radius: 50%; border: 3px solid #fff;
            position: absolute; bottom: 0; right: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none; /* åˆ†æå¾Œå…ˆé¡¯ç¤º */
        }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        
        #result-area { 
            display: none; margin-top: 30px; padding: 40px; 
            background: #fff; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .score-circle {
            width: 150px; height: 150px; background: #ffb703; color: #fff; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 0 auto 20px auto; box-shadow: 0 5px 15px rgba(255, 183, 3, 0.4);
        }
        .score-number { font-size: 3.5rem; font-weight: 800; line-height: 1; }
        
        .analysis-tags { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        .tag { background: #eee; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; color: #555; }
        .tag.highlight { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }

        details { text-align: left; background: #fff; padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px solid #eee; }
    </style>
</head>
<body>

    <main class="container">
        <h1>ğŸ¶ äººå¯µé…å°åˆ†æå„€</h1>
        <p>AI å…¨æ–¹ä½åˆ†æï¼šäº”å®˜ + è‰²ç³» + ç¥æƒ… (v2.0)</p>

        <div class="grid">
            <div>
                <h3>1. ä¸»äººç›¸ ğŸ‘±</h3>
                <div class="preview-box" id="box1" onclick="document.getElementById('upload1').click()">
                    <span style="color:#ccc; font-size:2rem;">+</span>
                    <div id="color1" class="color-dot"></div>
                </div>
                <input type="file" id="upload1" accept="image/*" onchange="loadFile(event, 'img1', 'box1')" style="display:none;">
                <img id="img1" style="display:none;" crossorigin="anonymous"> 
            </div>
            <div>
                <h3>2. å¯µç‰©ç›¸ ğŸ±</h3>
                <div class="preview-box" id="box2" onclick="document.getElementById('upload2').click()">
                     <span style="color:#ccc; font-size:2rem;">+</span>
                     <div id="color2" class="color-dot"></div>
                </div>
                <input type="file" id="upload2" accept="image/*" onchange="loadFile(event, 'img2', 'box2')" style="display:none;">
                <img id="img2" style="display:none;" crossorigin="anonymous">
            </div>
        </div>

        <details>
            <summary>âš™ï¸ é€²éšé¸é …</summary>
            <label><input type="checkbox" id="isHardMode"> é–‹å•Ÿå›°é›£æ¨¡å¼ (é»‘è¶…/å´é¢)</label>
        </details>
        <br>
        <button id="analyzeBtn" onclick="analyzeSimilarity()" disabled style="width: 100%; font-size: 1.2rem; padding: 20px;">ğŸ¤– ç«‹å³åˆ†æ</button>
        
        <div id="result-area">
            <div class="score-circle">
                <span class="score-number" id="score">0</span>
                <span>% ç›¸ä¼¼</span>
            </div>
            <h3 id="comment">æ­£åœ¨è§£è®€...</h3>
            
            <div class="analysis-tags" id="tags">
                <!-- æ¨™ç±¤æœƒä¿‚åº¦å‡ºç¾ -->
            </div>
            
            <br>
            <button onclick="window.location.reload()" class="secondary outline">ğŸ”„ å†ç©ä¸€æ¬¡</button>
        </div>
    </main>

    <script>
        let model;
        const colorThief = new ColorThief();
        const btn = document.getElementById('analyzeBtn');

        async function loadModel() {
            try {
                model = await mobilenet.load();
                btn.innerText = "âœ¨ ç«‹å³åˆ†æ";
                btn.disabled = false;
            } catch (e) { console.error(e); }
        }
        loadModel();

        function loadFile(event, imgId, boxId) {
            const output = document.getElementById(imgId);
            const box = document.getElementById(boxId);
            if (event.target.files && event.target.files[0]) {
                output.src = URL.createObjectURL(event.target.files[0]);
                output.onload = () => { URL.revokeObjectURL(output.src) }
                box.innerHTML = ""; 
                box.appendChild(output.cloneNode());
                box.children[0].style.display = "block";
                
                // åŠ ç•ªå€‹ Color Dot Container
                let dot = document.createElement("div");
                dot.className = "color-dot";
                dot.id = imgId.replace("img", "color");
                box.appendChild(dot);
                
                document.getElementById('result-area').style.display = 'none';
            }
        }

        async function analyzeSimilarity() {
            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');
            
            if (!img1.src || !img2.src) { alert("è«‹å…ˆä¸Šè¼‰å…©å¼µç›¸ï¼"); return; }

            btn.setAttribute("aria-busy", "true");
            
            setTimeout(async () => {
                try {
                    // 1. MobileNet åˆ†æ (äº”å®˜/è¼ªå»“)
                    const activation1 = model.infer(img1, true);
                    const activation2 = model.infer(img2, true);
                    const rawDist = cosineSimilarity(activation1, activation2);
                    
                    // 2. é¡è‰²åˆ†æ (Color Match)
                    const c1 = colorThief.getColor(img1); // [R, G, B]
                    const c2 = colorThief.getColor(img2);
                    
                    // é¡¯ç¤ºæ‰åˆ°æ—¢è‰²
                    document.getElementById('color1').style.background = `rgb(${c1.join(',')})`;
                    document.getElementById('color1').style.display = 'block';
                    document.getElementById('color2').style.background = `rgb(${c2.join(',')})`;
                    document.getElementById('color2').style.display = 'block';
                    
                    // è¨ˆç®—è‰²å·® (ç°¡å–®ç‰ˆ Euclidean distance)
                    const colorDist = Math.sqrt(
                        Math.pow(c1[0]-c2[0], 2) + 
                        Math.pow(c1[1]-c2[1], 2) + 
                        Math.pow(c1[2]-c2[2], 2)
                    );
                    const isColorMatch = colorDist < 60; // 60ä»¥ä¸‹ç®—ä¼¼è‰²
                    
                    // 3. è¨ˆåˆ† (Base Score)
                    // ç”¨ç•ªä½ å€‹ 0-80 é‚è¼¯
                    let score = mapRange(rawDist, 0.35, 0.75, 100, 10);
                    
                    // 4. åŠ åˆ† (Bonus)
                    let bonusMsg = [];
                    if (isColorMatch) {
                        score += 5; // æ’è‰²åŠ  5 åˆ†
                        bonusMsg.push("ğŸ¨ è‰²ç³»è¶…è¥¯");
                    }
                    if (document.getElementById('isHardMode').checked) score *= 0.9;
                    
                    // 5. å°é ‚
                    score = Math.min(99, Math.max(10, Math.round(score)));

                    // 6. é¡¯ç¤º
                    showResult(score, bonusMsg);

                } catch (error) { console.error(error); alert("åˆ†æå¤±æ•—"); }
                btn.setAttribute("aria-busy", "false");
            }, 100);
        }

        function showResult(score, tags) {
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('score').innerText = score;
            
            // è©•èª
            const comment = document.getElementById('comment');
            if(score > 90) comment.innerText = "ğŸ˜± å¤±æ•£å¤šå¹´æ—¢è¦ªäººï¼";
            else if(score > 75) comment.innerText = "â¤ï¸ é»˜å¥‘åè¶³ï¼Œå¤©ç”Ÿä¸€å°ï¼";
            else if(score > 60) comment.innerText = "ğŸ˜ å¹¾æœ‰çˆ¶å­/æ¯å¥³ç›¸ï¼";
            else comment.innerText = "ğŸ˜‚ é›–ç„¶å””ä¼¼ï¼Œä½†å‹åœ¨æœ‰æ„›ï¼";

            // Tags
            const tagContainer = document.getElementById('tags');
            tagContainer.innerHTML = "";
            tags.forEach(t => {
                tagContainer.innerHTML += `<span class="tag highlight">${t}</span>`;
            });
            if (score > 80) tagContainer.innerHTML += `<span class="tag">âœ¨ å®Œç¾å¥‘åˆ</span>`;
            tagContainer.innerHTML += `<span class="tag">ğŸ§¬ åŸºå› åˆ†æå®Œæˆ</span>`;
        }

        function cosineSimilarity(t1, t2) {
            const v1 = t1.dataSync(); const v2 = t2.dataSync();
            let dotProduct = 0, normA = 0, normB = 0;
            for (let i = 0; i < v1.length; i++) {
                dotProduct += v1[i] * v2[i];
                normA += v1[i] * v1[i];
                normB += v2[i] * v2[i];
            }
            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }

        function mapRange(value, low1, high1, low2, high2) {
            return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
        }
    </script>
</body>
</html>
