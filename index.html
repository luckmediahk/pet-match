<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººå¯µé…å° - æ•¸æ“šæ ¡æº–å°ˆç”¨ç‰ˆ ğŸ› ï¸</title>
    <!-- å¼•å…¥ Pico.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <!-- å¼•å…¥ TensorFlow.js åŒ MobileNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    <style>
        body { padding: 20px; text-align: center; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        .preview-box { 
            width: 150px; height: 150px; 
            border: 2px dashed #ccc; 
            margin: 10px auto; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; background: #fff; border-radius: 10px;
        }
        img { width: 100%; height: 100%; object-fit: cover; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        /* æ ¡æº–å·¥å…·å€ */
        .calibration-zone {
            background: #fff;
            border: 2px solid #333;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .slider-container { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        input[type=range] { flex-grow: 1; }
        .score-display { font-size: 1.5rem; font-weight: bold; color: #e63946; width: 60px; }
        
        #data-log { 
            margin-top: 20px; 
            text-align: left; 
            font-size: 0.8rem; 
            max-height: 200px; 
            overflow-y: auto; 
            background: #eee; 
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <main class="container">
        <hgroup>
            <h1>ğŸ› ï¸ æ ¡æº–æ•¸æ“šæ”¶é›†å™¨</h1>
            <h2>å¹« AI è£œç¿’ï¼šè©±ä¿¾ä½¢çŸ¥å’©å«ã€Œä¼¼ã€</h2>
        </hgroup>

        <!-- 1. ä¸Šè¼‰å€ -->
        <div class="grid">
            <div>
                <div class="preview-box" id="box1">ä¸»äºº</div>
                <input type="file" id="upload1" accept="image/*" onchange="loadFile(event, 'img1', 'box1')">
                <img id="img1" style="display:none;" crossorigin="anonymous"> 
            </div>
            <div>
                <div class="preview-box" id="box2">å¯µç‰©</div>
                <input type="file" id="upload2" accept="image/*" onchange="loadFile(event, 'img2', 'box2')">
                <img id="img2" style="display:none;" crossorigin="anonymous">
            </div>
        </div>

        <button id="analyzeBtn" onclick="analyzeSimilarity()" disabled>ğŸ¤– 1. å…ˆè¨ˆç®— AI åˆ†æ•¸</button>
        
        <!-- 2. äººå·¥è©•åˆ†å€ (éš±è—ç›´åˆ°åˆ†æå®Œæˆ) -->
        <div id="calibration-zone" class="calibration-zone" style="display:none;">
            <h3>ğŸ‘ï¸ 2. ä½ è¦ºå¾—æœ‰å¹¾ä¼¼ï¼Ÿ (äººå·¥è©•åˆ†)</h3>
            
            <div style="margin-bottom: 10px;">
                <strong>AI åŸå§‹è·é›¢ (Raw Distance): </strong> 
                <span id="raw-score-display" style="color:blue; font-weight:bold;">---</span>
            </div>

            <label for="human-score">æ‹‰å‹•æ»‘æ¡¿è©•åˆ† (0 = å””ä¼¼, 100 = é¤…å°):</label>
            <div class="slider-container">
                <span>0</span>
                <input type="range" id="human-score" min="0" max="100" value="50" oninput="updateSliderVal(this.value)">
                <span>100</span>
                <span id="slider-val" class="score-display">50</span>
            </div>

            <br>
            <button onclick="addDataPoint()" class="contrast">ğŸ“ 3. è¨˜éŒ„é€™çµ„æ•¸æ“š</button>
        </div>

        <!-- 3. æ•¸æ“šè¨˜éŒ„å€ -->
        <div style="margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px;">
            <h4>å·²æ”¶é›†æ•¸æ“š (<span id="count">0</span> çµ„)</h4>
            <pre id="data-log">æš«ç„¡æ•¸æ“š...</pre>
            <button onclick="downloadCSV()" class="secondary">â¬‡ï¸ ä¸‹è¼‰ CSV æª”æ¡ˆ (Send ä¿¾æˆ‘)</button>
        </div>

    </main>

    <script>
        let model;
        let currentRawScore = null;
        let dataPoints = []; // å„²å­˜æ‰€æœ‰æ•¸æ“š
        const btn = document.getElementById('analyzeBtn');

        // åˆå§‹åŒ–
        async function loadModel() {
            btn.innerText = "â³ è¼‰å…¥æ¨¡å‹ä¸­...";
            try {
                model = await mobilenet.load();
                console.log("Model Loaded!");
                btn.innerText = "ğŸ¤– 1. è¨ˆç®— AI åˆ†æ•¸";
                btn.disabled = false;
            } catch (e) {
                console.error(e);
                btn.innerText = "âš ï¸ æ¨¡å‹è¼‰å…¥å¤±æ•—";
            }
        }
        loadModel();

        // åœ–ç‰‡é è¦½
        function loadFile(event, imgId, boxId) {
            const output = document.getElementById(imgId);
            const box = document.getElementById(boxId);
            if (event.target.files && event.target.files[0]) {
                output.src = URL.createObjectURL(event.target.files[0]);
                output.onload = () => { URL.revokeObjectURL(output.src) }
                box.innerHTML = ""; 
                box.appendChild(output.cloneNode());
                box.children[0].style.display = "block";
                
                // Reset UI
                document.getElementById('calibration-zone').style.display = 'none';
                currentRawScore = null;
            }
        }

        // AI è¨ˆç®—
        async function analyzeSimilarity() {
            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');

            if (!img1.src || !img2.src || img1.src == "" || img2.src == "") {
                alert("è«‹å…ˆä¸Šè¼‰å…©å¼µç›¸ï¼");
                return;
            }

            btn.setAttribute("aria-busy", "true");
            
            // å»¶é²å°‘å°‘ä¿¾ UI update
            setTimeout(async () => {
                try {
                    const activation1 = model.infer(img1, true);
                    const activation2 = model.infer(img2, true);
                    const rawSim = cosineSimilarity(activation1, activation2);
                    
                    currentRawScore = rawSim; // æš«å­˜åˆ†æ•¸
                    
                    // é¡¯ç¤ºä¸‹ä¸€æ­¥
                    document.getElementById('calibration-zone').style.display = 'block';
                    document.getElementById('raw-score-display').innerText = rawSim.toFixed(5);
                    
                } catch (error) {
                    console.error(error);
                    alert("åˆ†æéŒ¯èª¤");
                }
                btn.setAttribute("aria-busy", "false");
            }, 100);
        }

        // è¨˜éŒ„æ•¸æ“š
        function addDataPoint() {
            if (currentRawScore === null) return;

            const humanScore = document.getElementById('human-score').value;
            
            // åŠ å…¥ Array
            dataPoints.push({
                raw_distance: currentRawScore.toFixed(5),
                human_score: humanScore,
                timestamp: new Date().toLocaleTimeString()
            });

            // æ›´æ–°ç•«é¢ Log
            updateLogDisplay();

            // é‡ç½® UI æ–¹ä¾¿ä¸‹ä¸€å¼µ
            alert(`å·²è¨˜éŒ„ï¼\nAIè·é›¢: ${currentRawScore.toFixed(4)}\nä½ ä¿¾æ—¢åˆ†: ${humanScore}`);
            document.getElementById('calibration-zone').style.display = 'none';
            document.getElementById('box1').innerText = "é è¦½åœ–";
            document.getElementById('box2').innerText = "é è¦½åœ–";
            document.getElementById('img1').removeAttribute('src');
            document.getElementById('img2').removeAttribute('src');
            document.getElementById('upload1').value = "";
            document.getElementById('upload2').value = "";
        }

        function updateSliderVal(val) {
            document.getElementById('slider-val').innerText = val;
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('data-log');
            document.getElementById('count').innerText = dataPoints.length;
            
            // é¡¯ç¤ºæœ€æ–° 5 æ¢
            let html = dataPoints.map((d, i) => 
                `#${i+1} -> AI: ${d.raw_distance} | äººé¡: ${d.human_score}%`
            ).join('\n');
            logDiv.innerText = html;
        }

        // ä¸‹è¼‰ CSV
        function downloadCSV() {
            if (dataPoints.length === 0) {
                alert("ç„¡æ•¸æ“šé» Download å•Šå¤§å“¥ï¼ŸğŸ˜…");
                return;
            }

            // è£½ä½œ CSV å…§å®¹
            let csvContent = "data:text/csv;charset=utf-8,Raw_Distance,Human_Score_Percent\n";
            dataPoints.forEach(row => {
                csvContent += `${row.raw_distance},${row.human_score}\n`;
            });

            // è§¸ç™¼ä¸‹è¼‰
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "calibration_data.csv");
            document.body.appendChild(link);
            link.click();
        }

        function cosineSimilarity(t1, t2) {
            const v1 = t1.dataSync();
            const v2 = t2.dataSync();
            let dotProduct = 0, normA = 0, normB = 0;
            for (let i = 0; i < v1.length; i++) {
                dotProduct += v1[i] * v2[i];
                normA += v1[i] * v1[i];
                normB += v2[i] * v2[i];
            }
            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }
    </script>
</body>
</html>
