<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ äººå¯µé…å° v4.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>

    <style>
        :root { --primary: #FFB703; --secondary: #219EBC; --bg: #FFF8F0; }
        body { 
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif; 
            background-color: var(--bg); color: #333; margin: 0; padding: 20px;
            background-image: radial-gradient(#FFB703 15%, transparent 16%), radial-gradient(#FFB703 15%, transparent 16%);
            background-size: 60px 60px; background-position: 0 0, 30px 30px;
        }
        
        .container { max-width: 600px; margin: 0 auto; background: rgba(255,255,255,0.95); padding: 30px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        h1 { color: #023047; margin-bottom: 5px; }
        p.subtitle { color: #8E9AAF; font-size: 0.9rem; margin-top: 0; }

        .preview-box { 
            width: 160px; height: 160px; 
            border: 4px solid #fff; outline: 3px dashed #ddd; margin: 20px auto; 
            position: relative; cursor: pointer;
            background: #f0f0f0; border-radius: 50%; 
            transition: transform 0.2s;
        }
        .preview-box:active { transform: scale(0.95); }
        .img-container { width: 100%; height: 100%; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        img { width: 100%; height: 100%; object-fit: cover; }
        
        .bubble {
            background: #fff; color: #333; padding: 10px 15px; border-radius: 15px;
            font-size: 0.8rem; font-weight: bold; position: absolute; top: -50px; right: -70px; width: 150px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid #333; display: none; z-index: 100;
        }
        /* Bubble arrow */
        .bubble::after { content: ''; position: absolute; bottom: -10px; left: 20px; border-width: 12px 10px 0; border-style: solid; border-color: #333 transparent; display: block; width: 0; }

        .grid { display: flex; justify-content: space-around; gap: 10px; margin: 30px 0; }
        
        button#analyzeBtn {
            background: var(--secondary); color: white; border: none; padding: 15px 40px;
            font-size: 1.2rem; border-radius: 50px; cursor: pointer; width: 100%;
            font-family: 'Fredoka', sans-serif; box-shadow: 0 5px 15px rgba(33, 158, 188, 0.4);
            transition: all 0.3s;
        }
        button#analyzeBtn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
        
        #result-card {
            display: none; margin-top: 30px; padding: 30px; background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
            border-radius: 20px; border: 1px solid #eee; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            text-align: center; position: relative; overflow: hidden;
        }
        
        .score-big { font-size: 5rem; font-weight: 800; color: var(--secondary); line-height: 1; margin: 10px 0; text-shadow: 2px 2px 0px #eee; }
        .verdict { font-size: 1.3rem; font-weight: bold; color: #FB8500; margin-bottom: 20px; }
        
        .detail-section { background: #f7f7f7; padding: 15px; border-radius: 15px; margin: 20px 0; text-align: left; }
        .detail-item { display: flex; align-items: center; gap: 10px; margin: 8px 0; font-size: 0.9rem; }
        .detail-item .emoji { font-size: 1.5rem; }
        
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 3rem;">ğŸ¶</div>
        <h3 style="color:#555;">æ­£åœ¨å–šé†’ AI ç‹—ç‹—...</h3>
    </div>

    <div class="container">
        <h1>ğŸ¾ äººå¯µé…å° v4.2</h1>
        <p class="subtitle">AI æ™ºèƒ½åˆ†æ â€¢ çœ‹çœ‹ä½ å€‘æœ‰å¤šä¼¼æ¨£ï¼Ÿ</p>

        <div class="grid">
            <!-- ä¸»äººç›¸ -->
            <div style="text-align:center;">
                <span style="font-size:1.5rem;">ğŸ‘±</span>
                <div class="preview-box" id="box1" onclick="document.getElementById('upload1').click()">
                    <div id="bubble1" class="bubble"></div>
                    <div class="img-container">
                        <span style="color:#ddd; font-size:3rem;">+</span>
                        <img id="img1" style="display:none;" crossorigin="anonymous">
                    </div>
                </div>
                <input type="file" id="upload1" accept="image/*" onchange="checkHuman(event)" style="display:none;">
            </div>
            <!-- ç‹—ç‹—ç›¸ -->
            <div style="text-align:center;">
                <span style="font-size:1.5rem;">ğŸ¶</span>
                <div class="preview-box" id="box2" onclick="document.getElementById('upload2').click()">
                     <div id="bubble2" class="bubble"></div>
                     <div class="img-container">
                        <span style="color:#ddd; font-size:3rem;">+</span>
                        <img id="img2" style="display:none;" crossorigin="anonymous">
                     </div>
                </div>
                <input type="file" id="upload2" accept="image/*" onchange="checkDog(event)" style="display:none;">
            </div>
        </div>

        <button id="analyzeBtn" onclick="analyzeSimilarity()" disabled>âœ¨ ç«‹å³åˆ†æ</button>
        
        <div id="result-card">
            <p style="color:#888; margin:0;">ç›¸ä¼¼åº¦åˆ†æçµæœ</p>
            <div class="score-big"><span id="score">0</span>%</div>
            <div class="verdict" id="comment">...</div>
            
            <div class="detail-section">
                <div style="font-weight:bold; margin-bottom:10px; color:#555;">ğŸ“Š AI åˆ†æå ±å‘Š</div>
                <div id="details"></div>
            </div>
            
            <div style="margin-top:20px; padding-top:20px; border-top:1px dashed #ddd; display:flex; justify-content:center; gap:20px;">
                <!-- ä¿®æ­£äº†é€™è£çš„ ID é‚è¼¯ï¼Œç¢ºä¿åœ–ç‰‡èƒ½é¡¯ç¤º -->
                <img id="res-img1" style="width:60px; height:60px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                <img id="res-img2" style="width:60px; height:60px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
            </div>

            <div style="font-size:0.8rem; color:#999; margin-top:20px;">
                ğŸ“¸ Cap åœ– Share å» IG Story å•¦ï¼
            </div>
        </div>
        
        <button onclick="window.location.reload()" style="background:transparent; color:#999; border:none; margin-top:20px; cursor:pointer; text-decoration:underline; display:none;" id="restartBtn">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>

    <script>
        let mobilenetModel, cocoSsdModel;
        const colorThief = new ColorThief();
        let img1Data = {name:'', size:0}, img2Data = {name:'', size:0}; // Seed data

        async function initAI() {
            try {
                cocoSsdModel = await cocoSsd.load();
                mobilenetModel = await mobilenet.load();
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (e) { alert("AI è¼‰å…¥å¤±æ•—"); }
        }
        initAI();

        // Load File function (Bug Fix: Remove revokeObjectURL)
        function loadFile(event, imgId, boxId) {
            return new Promise(resolve => {
                const output = document.getElementById(imgId);
                const file = event.target.files[0];
                if (file) {
                    // Save metadata for seed
                    if(imgId === 'img1') img1Data = { name: file.name, size: file.size };
                    if(imgId === 'img2') img2Data = { name: file.name, size: file.size };

                    // IMPORTANT: Do NOT revoke URL here, need it for result card later
                    output.src = URL.createObjectURL(file);
                    output.onload = () => { resolve(); }
                    output.style.display = 'block';
                    document.querySelector(`#${boxId} span`).style.display = 'none';
                }
            });
        }

        async function checkHuman(event) {
            await loadFile(event, 'img1', 'box1');
            const img = document.getElementById('img1');
            const bubble = document.getElementById('bubble1');
            bubble.style.display = 'none';

            // Real Check Logic Back!
            setTimeout(async () => {
                if (!cocoSsdModel) return;
                const detections = await cocoSsdModel.detect(img);
                
                const hasDog = detections.some(d => d.class === 'dog' && d.score > 0.4);
                if (hasDog) { showBubble(bubble, "ğŸ¶ å–‚å–‚ï¼å‘¢é‚Šä¿‚æ”¾ä¸»äººç›¸æ¶ï¼", true); }
                else { showBubble(bubble, "âœ… é€™å¼µç›¸å¥½æ­£ï¼", false); }
                
                checkReady();
            }, 300);
        }

        async function checkDog(event) {
            await loadFile(event, 'img2', 'box2');
            const img = document.getElementById('img2');
            const bubble = document.getElementById('bubble2');
            bubble.style.display = 'none';

            setTimeout(async () => {
                if (!cocoSsdModel) return;
                const detections = await cocoSsdModel.detect(img);
                
                const hasPerson = detections.some(d => d.class === 'person' && d.score > 0.5);
                const hasCat = detections.some(d => d.class === 'cat' && d.score > 0.4);

                if (hasPerson) { showBubble(bubble, "ğŸ¶ ä¸»å­ç¨ç…§å¥½å•²å–ï¼", true); }
                else if (hasCat) { showBubble(bubble, "ğŸ± å–µï¼Ÿå‘¢åº¦ä¿‚ç‹—ç‹—å°ˆå€å–ï¼", true); }
                else { showBubble(bubble, "âœ… æ”¶åˆ°ï¼ç¢ºèªä¿‚ç‹—ç‹—ï¼", false); }

                checkReady();
            }, 300);
        }

        function showBubble(el, msg, isWarning) {
            el.innerText = msg; el.style.display = 'block';
            el.style.border = isWarning ? '2px solid #fbc02d' : '2px solid #2e7d32';
            el.style.color = isWarning ? '#f57f17' : '#2e7d32';
        }

        function checkReady() {
            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');
            if (img1.style.display === 'block' && img2.style.display === 'block') {
                document.getElementById('analyzeBtn').disabled = false;
            }
        }
        
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) { hash = ((hash << 5) - hash) + str.charCodeAt(i); hash |= 0; }
            return Math.abs(hash);
        }
        
        async function analyzeSimilarity() {
            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');
            const btn = document.getElementById('analyzeBtn');
            
            btn.innerText = "ğŸ¤– åˆ†æä¸­...";
            btn.disabled = true;
            
            setTimeout(async () => {
                const act1 = mobilenetModel.infer(img1, true);
                const act2 = mobilenetModel.infer(img2, true);
                const rawDist = cosineSimilarity(act1, act2);
                
                const c1 = colorThief.getColor(img1);
                const c2 = colorThief.getColor(img2);
                const colorDiff = Math.sqrt(Math.pow(c1[0]-c2[0],2) + Math.pow(c1[1]-c2[1],2) + Math.pow(c1[2]-c2[2],2));
                
                // Breed Detection (New Feature!)
                const predictions = await mobilenetModel.classify(img2, 1);
                const breedName = predictions[0].className.split(',')[0]; // Get top 1 result

                // Seed Random
                const seed = simpleHash(img1Data.name + img1Data.size + img2Data.name + img2Data.size);
                const seededRandom = (seed % 10) - 5; 
                
                let score = mapRange(rawDist, 0.2, 0.8, 100, 30);
                let details = [];
                
                // Breed Tag
                details.push({ emoji: 'ğŸ•', text: `å“ç¨®ä¼¼ä¿‚ï¼š${breedName}` });

                if (colorDiff < 80) { score += 15; details.push({ emoji: 'ğŸ¨', text: 'è‰²ç³»è¶…å¤¾ (Color Match)' }); }
                if (rawDist > 0.5) { details.push({ emoji: 'ğŸ“', text: 'äº”å®˜/æ§‹åœ–ç¥ä¼¼' }); }
                
                score += seededRandom;
                score = Math.min(98, Math.max(12, Math.round(score)));
                
                const comments = [
                    { min: 90, text: "ğŸ˜± æ ¹æœ¬ä¿‚å‰ä¸–æƒ…äººï¼" },
                    { min: 80, text: "â¤ï¸ é¤…å°å’æ¬¾ï¼Œçµ•é…ï¼" },
                    { min: 70, text: "ğŸ˜ å¹¾æœ‰çˆ¶å­/æ¯å¥³ç›¸ï¼" },
                    { min: 50, text: "ğŸ¤” æ°£è³ªå¹¾ä¼¼ï¼Œå¯ä»¥ä¸€æˆ°ï¼" },
                    { min: 0,  text: "ğŸ˜‚ å””ä¼¼æ¨£ï¼Œä½†å‹åœ¨æœ‰æ„›ï¼" }
                ];
                const verdict = comments.find(c => score >= c.min).text;

                document.getElementById('score').innerText = score;
                document.getElementById('comment').innerText = verdict;
                
                // Fix for broken images: Re-assign src
                document.getElementById('res-img1').src = img1.src;
                document.getElementById('res-img2').src = img2.src;
                
                const detailsDiv = document.getElementById('details');
                detailsDiv.innerHTML = '';
                details.forEach(d => { detailsDiv.innerHTML += `<div class="detail-item"><span class="emoji">${d.emoji}</span> ${d.text}</div>`; });
                
                document.getElementById('result-card').style.display = 'block';
                document.getElementById('restartBtn').style.display = 'block';
                btn.style.display = 'none';

            }, 800);
        }

        function cosineSimilarity(t1, t2) {
            const v1 = t1.dataSync(); const v2 = t2.dataSync();
            let dotProduct = 0, normA = 0, normB = 0;
            for (let i = 0; i < v1.length; i++) { dotProduct += v1[i] * v2[i]; normA += v1[i] * v1[i]; normB += v2[i] * v2[i]; }
            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }
        function mapRange(value, low1, high1, low2, high2) {
            return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
        }
    </script>
</body>
</html>
