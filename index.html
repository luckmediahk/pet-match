<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ äººå¯µé…å° v3.0 (æ™ºèƒ½åµæ¸¬ç‰ˆ)</title>
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <!-- AI Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>

    <style>
        body { padding: 20px; text-align: center; max-width: 800px; margin: 0 auto; background-color: #fdfbf7; font-family: 'Segoe UI', sans-serif; }
        
        .preview-box { 
            width: 180px; height: 180px; 
            border: 3px solid #eee; margin: 10px auto; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; background: #fff; border-radius: 50%; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; cursor: pointer;
        }
        img { width: 100%; height: 100%; object-fit: cover; }
        
        /* é¬¼é¦¬æç¤º Bubble */
        .bubble {
            background: #333; color: #fff; padding: 5px 10px; border-radius: 10px;
            font-size: 0.8rem; position: absolute; bottom: -10px; left: 50%; 
            transform: translateX(-50%); width: 120%; z-index: 10;
            display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .bubble::after {
            content: ''; position: absolute; top: -5px; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: transparent transparent #333 transparent;
        }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        #result-area { display: none; margin-top: 30px; padding: 40px; background: #fff; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .score-circle { width: 150px; height: 150px; background: #ffb703; color: #fff; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 20px auto; }
        .score-number { font-size: 3.5rem; font-weight: 800; line-height: 1; }
        
        .tag { background: #eee; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; color: #555; margin: 5px; display:inline-block;}
        .tag.highlight { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        
        /* Loading Overlay */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:99; display:flex; justify-content:center; align-items:center; flex-direction:column; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <h2>ğŸš€ æ­£åœ¨å•Ÿå‹• AI å¼•æ“...</h2>
        <p>è¼‰å…¥äººè‡‰è­˜åˆ¥æ¨¡çµ„ (é¦–æ¬¡éœ€æ™‚ç´„ 10 ç§’)</p>
    </div>

    <main class="container">
        <h1>ğŸ¶ äººå¯µé…å° v3.0</h1>
        <p>æ™ºèƒ½åµæ¸¬ï¼šé»‘è¶…ã€å´é¢ã€å…‰ç·šé€šé€šè­˜ç‡ï¼</p>

        <div class="grid">
            <!-- ä¸»äººç›¸ -->
            <div>
                <h3>1. ä¸»äººç›¸ ğŸ‘±</h3>
                <div class="preview-box" id="box1" onclick="document.getElementById('upload1').click()">
                    <span style="color:#ccc; font-size:2rem;">+</span>
                    <div id="bubble1" class="bubble"></div>
                </div>
                <input type="file" id="upload1" accept="image/*" onchange="checkHuman(event)" style="display:none;">
                <img id="img1" style="display:none;" crossorigin="anonymous"> 
            </div>
            <!-- ç‹—ç‹—ç›¸ -->
            <div>
                <h3>2. ç‹—ç‹—ç›¸ ğŸ¶</h3>
                <div class="preview-box" id="box2" onclick="document.getElementById('upload2').click()">
                     <span style="color:#ccc; font-size:2rem;">+</span>
                     <div id="bubble2" class="bubble"></div>
                </div>
                <input type="file" id="upload2" accept="image/*" onchange="checkDog(event)" style="display:none;">
                <img id="img2" style="display:none;" crossorigin="anonymous">
            </div>
        </div>

        <button id="analyzeBtn" onclick="analyzeSimilarity()" disabled style="width: 100%; font-size: 1.2rem; padding: 20px;">ğŸ¤– ç«‹å³åˆ†æ</button>
        
        <div id="result-area">
            <div class="score-circle">
                <span class="score-number" id="score">0</span>
                <span>% ç›¸ä¼¼</span>
            </div>
            <h3 id="comment">...</h3>
            <div id="tags"></div>
            <br>
            <button onclick="window.location.reload()" class="secondary outline">ğŸ”„ å†ç©ä¸€æ¬¡</button>
        </div>
    </main>

    <script>
        let mobilenetModel;
        const colorThief = new ColorThief();
        const btn = document.getElementById('analyzeBtn');
        let humanStatus = { isHard: false, msg: "" };
        let dogStatus = { isHard: false, msg: "" };

        // 1. åˆå§‹åŒ– AI
        async function initAI() {
            try {
                // Load MobileNet
                mobilenetModel = await mobilenet.load();
                
                // Load Face-API (åªç”¨æœ€è¼•é‡ç‰ˆ TinyFaceDetector)
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                
                document.getElementById('loading-overlay').style.display = 'none';
                console.log("All Models Loaded");
            } catch (e) {
                console.error(e);
                alert("AI è¼‰å…¥å¤±æ•—ï¼Œè«‹ Refresh è©¦è©¦");
            }
        }
        initAI();

                // 2. æª¢æŸ¥äººé¡ç›¸ (Smart Check)
        async function checkHuman(event) {
            await loadFile(event, 'img1', 'box1', 'bubble1');
            const img = document.getElementById('img1');
            const bubble = document.getElementById('bubble1');
            
            humanStatus = { isHard: false, msg: "" }; // Reset
            bubble.style.display = 'none';

            // ç­‰åœ– Load å®Œ
            setTimeout(async () => {
                // Face Detection
                const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
                
                // æª¢æŸ¥å…‰æš—
                const brightness = getBrightness(img);

                if (!detection) {
                    // å¦‚æœå®Œå…¨æ‰¾ä¸åˆ°äººè‡‰
                    showBubble(bubble, "ğŸ¤” æµå””åˆ°äººæ¨£å–ï¼Ÿä½ ä¿‚å’ªéš±å½¢ä¿ ï¼Ÿ", true);
                    return;
                }

                const landmarks = detection.landmarks;
                const leftEye = landmarks.getLeftEye();
                const rightEye = landmarks.getRightEye();
                const eyeDist = Math.abs(leftEye[0].x - rightEye[3].x);
                const faceWidth = detection.detection.box.width;

                // --- é¬¼é¦¬è©•èª Logic ---
                
                if (brightness < 50) {
                    showBubble(bubble, "ğŸ’¡ é–‹ç›ç‡ˆå¯ä»¥å—ï¼Ÿä½ å—°é‚Šé›»è²»å¥½è²´ï¼Ÿ", true);
                } 
                else if (eyeDist < faceWidth * 0.25) {
                    showBubble(bubble, "ğŸ‘€ å´é¢ä¿‚éšï¼Œä½†æ­£é¢ä»²éšï¼Œä¿¾å€‹æ­£é¢é»ç‡å“å•¦ï¼", true);
                } 
                else if (detection.detection.score < 0.7) {
                    // åˆ†æ•¸ä½é€šå¸¸ä¿‚æˆ´å·¦é‡æˆ–è€…æ¨¡ç³Š
                    showBubble(bubble, "ğŸ˜ æˆ´ä½é»‘è¶…å¤ªæœ‰å‹å–‡ï¼æ‰£ä½ 50åˆ†ï¼", true);
                }
                else if (detection.detection.box.width < img.width * 0.15) {
                     // äººè‡‰ä½”æ¯”å¤ªç´°
                    showBubble(bubble, "ğŸ” æœ‰å‹ä½ è¡Œè¿‘å°‘å°‘å•Šï½", true);
                }
                else {
                    showBubble(bubble, "âœ… éšä»”/éšå¥³ï¼é€™å¼µç›¸å¾ˆå®Œç¾ï¼", false);
                }
                
                checkReady();
            }, 500);
        }


        // 3. æª¢æŸ¥ç‹—ç‹—ç›¸
        async function checkDog(event) {
            await loadFile(event, 'img2', 'box2', 'bubble2');
            const img = document.getElementById('img2');
            const bubble = document.getElementById('bubble2');
            
            dogStatus = { isHard: false, msg: "" };
            bubble.style.display = 'none';

            setTimeout(async () => {
                const predictions = await mobilenetModel.classify(img);
                const isDog = predictions.some(p => p.className.toLowerCase().includes('dog') || p.className.toLowerCase().includes('terrier') || p.className.toLowerCase().includes('retriever'));
                
                if (!isDog) {
                    showBubble(bubble, "ğŸ¶ æ±ªï¼ŸAI è©±å‘¢éš»å””ä¼¼ä¿‚ç‹—å–...", true);
                } else {
                    const breed = predictions[0].className.split(',')[0];
                    showBubble(bubble, `âœ… æ”¶åˆ°ï¼ä¿‚ä¸€éš»å¯æ„›çš„ ${breed}`, false);
                }
                checkReady();
            }, 500);
        }

        function showBubble(el, msg, isWarning) {
            el.innerText = msg;
            el.style.display = 'block';
            el.style.background = isWarning ? '#d32f2f' : '#2e7d32'; // ç´…è‰² / ç¶ è‰²
            
            if (isWarning) {
                if (el.id === 'bubble1') humanStatus.isHard = true;
                if (el.id === 'bubble2') dogStatus.isHard = true;
            }
        }

        // é€šç”¨ Load åœ–
        function loadFile(event, imgId, boxId, bubbleId) {
            return new Promise(resolve => {
                const output = document.getElementById(imgId);
                const box = document.getElementById(boxId);
                if (event.target.files && event.target.files[0]) {
                    output.src = URL.createObjectURL(event.target.files[0]);
                    output.onload = () => { URL.revokeObjectURL(output.src); resolve(); }
                    box.innerHTML = ""; 
                    box.appendChild(output.cloneNode());
                    
                    // é‡å»º Bubble
                    let b = document.createElement("div");
                    b.id = bubbleId;
                    b.className = "bubble";
                    box.appendChild(b);
                    
                    box.children[0].style.display = "block";
                }
            });
        }

        function checkReady() {
            const img1 = document.getElementById('img1').src;
            const img2 = document.getElementById('img2').src;
            if (img1 && img2) btn.disabled = false;
        }

        function getBrightness(image) {
            // ç°¡å–®æŠ½æ¨£å…‰åº¦
            let canvas = document.createElement('canvas');
            canvas.width = image.width; canvas.height = image.height;
            let ctx = canvas.getContext('2d');
            ctx.drawImage(image, 0, 0);
            let imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
            let r,g,b,avg;
            let colorSum = 0;
            for(let x = 0, len = imageData.data.length; x < len; x+=4) {
                r = imageData.data[x]; g = imageData.data[x+1]; b = imageData.data[x+2];
                avg = Math.floor((r+g+b)/3);
                colorSum += avg;
            }
            return Math.floor(colorSum / (image.width*image.height));
        }

        // åˆ†æé‚è¼¯
        async function analyzeSimilarity() {
            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');
            btn.setAttribute("aria-busy", "true");

            setTimeout(async () => {
                const activation1 = mobilenetModel.infer(img1, true);
                const activation2 = mobilenetModel.infer(img2, true);
                const rawDist = cosineSimilarity(activation1, activation2);
                
                // --- 2.0 æ–°è¨ˆåˆ† Logic ---
                // 0.35 = 100åˆ†, 0.75 = 10åˆ†
                let score = mapRange(rawDist, 0.35, 0.75, 100, 10);
                
                // è™•ç†å›°é›£æ¨¡å¼
                let bonusTags = [];
                if (humanStatus.isHard && dogStatus.isHard) {
                    score += 5; // å¤§å®¶éƒ½é»‘è¶…/å´é¢ -> åŠ åˆ†ï¼
                    bonusTags.push("ğŸ˜ å…©å€‹éƒ½å’å‹");
                } else if (humanStatus.isHard || dogStatus.isHard) {
                    score *= 0.9; // ä¸€å€‹æ­£å¸¸ä¸€å€‹å””æ­£å¸¸ -> æ‰£åˆ†
                    bonusTags.push("ğŸ“‰ å—å…‰ç·š/è§’åº¦å½±éŸ¿");
                }

                // é¡è‰²åŠ åˆ†
                const c1 = colorThief.getColor(img1);
                const c2 = colorThief.getColor(img2);
                const colorDist = Math.sqrt(Math.pow(c1[0]-c2[0],2) + Math.pow(c1[1]-c2[1],2) + Math.pow(c1[2]-c2[2],2));
                if (colorDist < 60) { score += 5; bonusTags.push("ğŸ¨ è‰²ç³»å¥½è¥¯"); }

                score = Math.min(99, Math.max(10, Math.round(score)));
                showResult(score, bonusTags);
                
                btn.setAttribute("aria-busy", "false");
            }, 100);
        }

        function showResult(score, tags) {
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('score').innerText = score;
            const comment = document.getElementById('comment');
            if(score > 90) comment.innerText = "ğŸ˜± å¤±æ•£å¤šå¹´æ—¢è¦ªäººï¼";
            else if(score > 75) comment.innerText = "â¤ï¸ é»˜å¥‘åè¶³ï¼Œå¤©ç”Ÿä¸€å°ï¼";
            else if(score > 60) comment.innerText = "ğŸ˜ å¹¾æœ‰çˆ¶å­/æ¯å¥³ç›¸ï¼";
            else comment.innerText = "ğŸ˜‚ é›–ç„¶å””ä¼¼ï¼Œä½†å‹åœ¨æœ‰æ„›ï¼";

            const tagContainer = document.getElementById('tags');
            tagContainer.innerHTML = "";
            tags.forEach(t => tagContainer.innerHTML += `<span class="tag highlight">${t}</span>`);
        }

        function cosineSimilarity(t1, t2) {
            const v1 = t1.dataSync(); const v2 = t2.dataSync();
            let dotProduct = 0, normA = 0, normB = 0;
            for (let i = 0; i < v1.length; i++) {
                dotProduct += v1[i] * v2[i];
                normA += v1[i] * v1[i];
                normB += v2[i] * v2[i];
            }
            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }

        function mapRange(value, low1, high1, low2, high2) {
            return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
        }
    </script>
</body>
</html>
