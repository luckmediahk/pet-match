<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººå¯µé…å° - æ•¸æ“šæ ¡æº– (v1.2) ğŸ› ï¸</title>
    <!-- å¼•å…¥ Pico.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <!-- å¼•å…¥ TensorFlow.js åŒ MobileNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    <style>
        body { padding: 20px; text-align: center; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        .preview-box { 
            width: 150px; height: 150px; 
            border: 2px dashed #ccc; 
            margin: 10px auto; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; background: #fff; border-radius: 10px;
        }
        img { width: 100%; height: 100%; object-fit: cover; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        /* æ ¡æº–å·¥å…·å€ */
        .calibration-zone {
            background: #fff; border: 2px solid #333; padding: 20px; border-radius: 15px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;
        }
        .slider-container { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        input[type=range] { flex-grow: 1; }
        .score-display { font-size: 1.5rem; font-weight: bold; color: #e63946; width: 60px; }
        
        /* é›£åº¦é¸æ“‡æŒ‰éˆ• */
        .difficulty-group { display: flex; justify-content: space-around; margin-bottom: 20px; text-align: left; }
        .difficulty-option { cursor: pointer; padding: 10px; border: 1px solid #ddd; border-radius: 8px; flex: 1; margin: 0 5px; text-align: center; }
        .difficulty-option:hover { background: #f0f0f0; }
        input[type="radio"] { margin-right: 5px; }

        #data-log { margin-top: 20px; text-align: left; font-size: 0.8rem; max-height: 200px; overflow-y: auto; background: #eee; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <main class="container">
        <hgroup>
            <h1>ğŸ› ï¸ æ•¸æ“šæ ¡æº– v1.2</h1>
            <h2>åŠ å…¥é›£åº¦æ¨™ç±¤ï¼Œæå‡ AI æº–ç¢ºåº¦</h2>
        </hgroup>

        <!-- 1. ä¸Šè¼‰å€ -->
        <div class="grid">
            <div>
                <div class="preview-box" id="box1">ä¸»äºº</div>
                <input type="file" id="upload1" accept="image/*" onchange="loadFile(event, 'img1', 'box1')">
                <img id="img1" style="display:none;" crossorigin="anonymous"> 
            </div>
            <div>
                <div class="preview-box" id="box2">å¯µç‰©</div>
                <input type="file" id="upload2" accept="image/*" onchange="loadFile(event, 'img2', 'box2')">
                <img id="img2" style="display:none;" crossorigin="anonymous">
            </div>
        </div>

        <button id="analyzeBtn" onclick="analyzeSimilarity()" disabled>ğŸ¤– 1. å…ˆè¨ˆç®— AI åˆ†æ•¸</button>
        
        <!-- 2. äººå·¥è©•åˆ†å€ -->
        <div id="calibration-zone" class="calibration-zone">
            <h3>ğŸ‘ï¸ 2. è«‹è¼¸å…¥æ•¸æ“š</h3>
            
            <div style="margin-bottom: 15px;">
                <strong>AI åŸå§‹è·é›¢ (Raw): </strong> 
                <span id="raw-score-display" style="color:blue; font-weight:bold;">---</span>
            </div>

            <!-- é›£åº¦é¸æ“‡ -->
            <fieldset>
                <legend><strong>é›£åº¦ (Difficulty)</strong></legend>
                <div class="difficulty-group">
                    <label class="difficulty-option" style="border-bottom: 3px solid #4CAF50;">
                        <input type="radio" name="difficulty" value="Easy" checked>
                        Easy<br><small>(æ­£é¢/ç„¡é®)</small>
                    </label>
                    <label class="difficulty-option" style="border-bottom: 3px solid #FFC107;">
                        <input type="radio" name="difficulty" value="Medium">
                        Medium<br><small>(è¼•å¾®/çœ¼é¡)</small>
                    </label>
                    <label class="difficulty-option" style="border-bottom: 3px solid #F44336;">
                        <input type="radio" name="difficulty" value="Hard">
                        Hard<br><small>(é»‘è¶…/å´é¢)</small>
                    </label>
                </div>
            </fieldset>

            <!-- ç›¸ä¼¼åº¦æ»‘æ¡¿ -->
            <label for="human-score"><strong>äººçœ¼è¦ºå¾—å¹¾ä¼¼? (0-100)</strong></label>
            <div class="slider-container">
                <span>0</span>
                <input type="range" id="human-score" min="0" max="100" value="50" oninput="updateSliderVal(this.value)">
                <span>100</span>
                <span id="slider-val" class="score-display">50</span>
            </div>

            <button onclick="addDataPoint()" class="contrast">ğŸ“ 3. è¨˜éŒ„ä¸¦ä¸‹ä¸€å¼µ</button>
        </div>

        <!-- 3. æ•¸æ“šè¨˜éŒ„å€ -->
        <div style="margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px;">
            <h4>å·²æ”¶é›†: <span id="count">0</span> çµ„</h4>
            <pre id="data-log">æš«ç„¡æ•¸æ“š...</pre>
            <button onclick="downloadCSV()" class="secondary">â¬‡ï¸ ä¸‹è¼‰ CSV (Send ä¿¾æˆ‘)</button>
        </div>

    </main>

    <script>
        let model;
        let currentRawScore = null;
        let dataPoints = [];
        const btn = document.getElementById('analyzeBtn');

        // åˆå§‹åŒ–
        async function loadModel() {
            btn.innerText = "â³ è¼‰å…¥æ¨¡å‹ä¸­...";
            try {
                model = await mobilenet.load();
                console.log("Model Loaded!");
                btn.innerText = "ğŸ¤– 1. è¨ˆç®— AI åˆ†æ•¸";
                btn.disabled = false;
            } catch (e) {
                console.error(e);
                btn.innerText = "âš ï¸ æ¨¡å‹è¼‰å…¥å¤±æ•—";
            }
        }
        loadModel();

        function loadFile(event, imgId, boxId) {
            const output = document.getElementById(imgId);
            const box = document.getElementById(boxId);
            if (event.target.files && event.target.files[0]) {
                output.src = URL.createObjectURL(event.target.files[0]);
                output.onload = () => { URL.revokeObjectURL(output.src) }
                box.innerHTML = ""; 
                box.appendChild(output.cloneNode());
                box.children[0].style.display = "block";
                
                document.getElementById('calibration-zone').style.display = 'none';
                currentRawScore = null;
            }
        }

        async function analyzeSimilarity() {
            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');

            if (!img1.src || !img2.src || img1.src == "" || img2.src == "") {
                alert("è«‹å…ˆä¸Šè¼‰å…©å¼µç›¸ï¼");
                return;
            }

            btn.setAttribute("aria-busy", "true");
            
            setTimeout(async () => {
                try {
                    const activation1 = model.infer(img1, true);
                    const activation2 = model.infer(img2, true);
                    const rawSim = cosineSimilarity(activation1, activation2);
                    
                    currentRawScore = rawSim;
                    
                    document.getElementById('calibration-zone').style.display = 'block';
                    document.getElementById('raw-score-display').innerText = rawSim.toFixed(5);
                    
                } catch (error) {
                    console.error(error);
                    alert("åˆ†æéŒ¯èª¤");
                }
                btn.setAttribute("aria-busy", "false");
            }, 100);
        }

        function addDataPoint() {
            if (currentRawScore === null) return;

            const humanScore = document.getElementById('human-score').value;
            // ç²å–é¸æ“‡çš„é›£åº¦
            const difficulty = document.querySelector('input[name="difficulty"]:checked').value;
            
            dataPoints.push({
                raw_distance: currentRawScore.toFixed(5),
                human_score: humanScore,
                difficulty: difficulty, // æ–°å¢æ¬„ä½
                timestamp: new Date().toLocaleTimeString()
            });

            updateLogDisplay();

            // Reset UI
            alert(`å·²è¨˜éŒ„ï¼\né›£åº¦: ${difficulty}\nAIè·é›¢: ${currentRawScore.toFixed(4)}\näººè©•: ${humanScore}`);
            document.getElementById('calibration-zone').style.display = 'none';
            document.getElementById('box1').innerText = "ä¸»äºº";
            document.getElementById('box2').innerText = "å¯µç‰©";
            document.getElementById('img1').removeAttribute('src');
            document.getElementById('img2').removeAttribute('src');
            document.getElementById('upload1').value = "";
            document.getElementById('upload2').value = "";
            
            // é‡ç½®æ»‘æ¡¿åŒ Radio
            document.getElementById('human-score').value = 50;
            document.getElementById('slider-val').innerText = "50";
            document.querySelector('input[name="difficulty"][value="Easy"]').checked = true;
        }

        function updateSliderVal(val) {
            document.getElementById('slider-val').innerText = val;
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('data-log');
            document.getElementById('count').innerText = dataPoints.length;
            
            let html = dataPoints.map((d, i) => 
                `#${i+1} [${d.difficulty}] AI:${d.raw_distance} | äºº:${d.human_score}`
            ).join('\n');
            logDiv.innerText = html;
        }

        function downloadCSV() {
            if (dataPoints.length === 0) {
                alert("ç„¡æ•¸æ“šé» Download å•Šï¼Ÿ");
                return;
            }
            // CSV Header å¤šå·¦ Difficulty
            let csvContent = "data:text/csv;charset=utf-8,Raw_Distance,Human_Score,Difficulty\n";
            dataPoints.forEach(row => {
                csvContent += `${row.raw_distance},${row.human_score},${row.difficulty}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "calibration_data_v1.2.csv");
            document.body.appendChild(link);
            link.click();
        }

        function cosineSimilarity(t1, t2) {
            const v1 = t1.dataSync();
            const v2 = t2.dataSync();
            let dotProduct = 0, normA = 0, normB = 0;
            for (let i = 0; i < v1.length; i++) {
                dotProduct += v1[i] * v2[i];
                normA += v1[i] * v1[i];
                normB += v2[i] * v2[i];
            }
            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }
    </script>
</body>
</html>
